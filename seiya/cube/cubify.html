<!DOCTYPE html>
<!-- Generated by Cython 0.29.6 -->
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Cython: cubify.pyx</title>
    <style type="text/css">
    
body.cython { font-family: courier; font-size: 12; }

.cython.tag  {  }
.cython.line { margin: 0em }
.cython.code { font-size: 9; color: #444444; display: none; margin: 0px 0px 0px 8px; border-left: 8px none; }

.cython.line .run { background-color: #B0FFB0; }
.cython.line .mis { background-color: #FFB0B0; }
.cython.code.run  { border-left: 8px solid #B0FFB0; }
.cython.code.mis  { border-left: 8px solid #FFB0B0; }

.cython.code .py_c_api  { color: red; }
.cython.code .py_macro_api  { color: #FF7000; }
.cython.code .pyx_c_api  { color: #FF3000; }
.cython.code .pyx_macro_api  { color: #FF7000; }
.cython.code .refnanny  { color: #FFA000; }
.cython.code .trace  { color: #FFA000; }
.cython.code .error_goto  { color: #FFA000; }

.cython.code .coerce  { color: #008000; border: 1px dotted #008000 }
.cython.code .py_attr { color: #FF0000; font-weight: bold; }
.cython.code .c_attr  { color: #0000FF; }
.cython.code .py_call { color: #FF0000; font-weight: bold; }
.cython.code .c_call  { color: #0000FF; }

.cython.score-0 {background-color: #FFFFff;}
.cython.score-1 {background-color: #FFFFe7;}
.cython.score-2 {background-color: #FFFFd4;}
.cython.score-3 {background-color: #FFFFc4;}
.cython.score-4 {background-color: #FFFFb6;}
.cython.score-5 {background-color: #FFFFaa;}
.cython.score-6 {background-color: #FFFF9f;}
.cython.score-7 {background-color: #FFFF96;}
.cython.score-8 {background-color: #FFFF8d;}
.cython.score-9 {background-color: #FFFF86;}
.cython.score-10 {background-color: #FFFF7f;}
.cython.score-11 {background-color: #FFFF79;}
.cython.score-12 {background-color: #FFFF73;}
.cython.score-13 {background-color: #FFFF6e;}
.cython.score-14 {background-color: #FFFF6a;}
.cython.score-15 {background-color: #FFFF66;}
.cython.score-16 {background-color: #FFFF62;}
.cython.score-17 {background-color: #FFFF5e;}
.cython.score-18 {background-color: #FFFF5b;}
.cython.score-19 {background-color: #FFFF57;}
.cython.score-20 {background-color: #FFFF55;}
.cython.score-21 {background-color: #FFFF52;}
.cython.score-22 {background-color: #FFFF4f;}
.cython.score-23 {background-color: #FFFF4d;}
.cython.score-24 {background-color: #FFFF4b;}
.cython.score-25 {background-color: #FFFF48;}
.cython.score-26 {background-color: #FFFF46;}
.cython.score-27 {background-color: #FFFF44;}
.cython.score-28 {background-color: #FFFF43;}
.cython.score-29 {background-color: #FFFF41;}
.cython.score-30 {background-color: #FFFF3f;}
.cython.score-31 {background-color: #FFFF3e;}
.cython.score-32 {background-color: #FFFF3c;}
.cython.score-33 {background-color: #FFFF3b;}
.cython.score-34 {background-color: #FFFF39;}
.cython.score-35 {background-color: #FFFF38;}
.cython.score-36 {background-color: #FFFF37;}
.cython.score-37 {background-color: #FFFF36;}
.cython.score-38 {background-color: #FFFF35;}
.cython.score-39 {background-color: #FFFF34;}
.cython.score-40 {background-color: #FFFF33;}
.cython.score-41 {background-color: #FFFF32;}
.cython.score-42 {background-color: #FFFF31;}
.cython.score-43 {background-color: #FFFF30;}
.cython.score-44 {background-color: #FFFF2f;}
.cython.score-45 {background-color: #FFFF2e;}
.cython.score-46 {background-color: #FFFF2d;}
.cython.score-47 {background-color: #FFFF2c;}
.cython.score-48 {background-color: #FFFF2b;}
.cython.score-49 {background-color: #FFFF2b;}
.cython.score-50 {background-color: #FFFF2a;}
.cython.score-51 {background-color: #FFFF29;}
.cython.score-52 {background-color: #FFFF29;}
.cython.score-53 {background-color: #FFFF28;}
.cython.score-54 {background-color: #FFFF27;}
.cython.score-55 {background-color: #FFFF27;}
.cython.score-56 {background-color: #FFFF26;}
.cython.score-57 {background-color: #FFFF26;}
.cython.score-58 {background-color: #FFFF25;}
.cython.score-59 {background-color: #FFFF24;}
.cython.score-60 {background-color: #FFFF24;}
.cython.score-61 {background-color: #FFFF23;}
.cython.score-62 {background-color: #FFFF23;}
.cython.score-63 {background-color: #FFFF22;}
.cython.score-64 {background-color: #FFFF22;}
.cython.score-65 {background-color: #FFFF22;}
.cython.score-66 {background-color: #FFFF21;}
.cython.score-67 {background-color: #FFFF21;}
.cython.score-68 {background-color: #FFFF20;}
.cython.score-69 {background-color: #FFFF20;}
.cython.score-70 {background-color: #FFFF1f;}
.cython.score-71 {background-color: #FFFF1f;}
.cython.score-72 {background-color: #FFFF1f;}
.cython.score-73 {background-color: #FFFF1e;}
.cython.score-74 {background-color: #FFFF1e;}
.cython.score-75 {background-color: #FFFF1e;}
.cython.score-76 {background-color: #FFFF1d;}
.cython.score-77 {background-color: #FFFF1d;}
.cython.score-78 {background-color: #FFFF1c;}
.cython.score-79 {background-color: #FFFF1c;}
.cython.score-80 {background-color: #FFFF1c;}
.cython.score-81 {background-color: #FFFF1c;}
.cython.score-82 {background-color: #FFFF1b;}
.cython.score-83 {background-color: #FFFF1b;}
.cython.score-84 {background-color: #FFFF1b;}
.cython.score-85 {background-color: #FFFF1a;}
.cython.score-86 {background-color: #FFFF1a;}
.cython.score-87 {background-color: #FFFF1a;}
.cython.score-88 {background-color: #FFFF1a;}
.cython.score-89 {background-color: #FFFF19;}
.cython.score-90 {background-color: #FFFF19;}
.cython.score-91 {background-color: #FFFF19;}
.cython.score-92 {background-color: #FFFF19;}
.cython.score-93 {background-color: #FFFF18;}
.cython.score-94 {background-color: #FFFF18;}
.cython.score-95 {background-color: #FFFF18;}
.cython.score-96 {background-color: #FFFF18;}
.cython.score-97 {background-color: #FFFF17;}
.cython.score-98 {background-color: #FFFF17;}
.cython.score-99 {background-color: #FFFF17;}
.cython.score-100 {background-color: #FFFF17;}
.cython.score-101 {background-color: #FFFF16;}
.cython.score-102 {background-color: #FFFF16;}
.cython.score-103 {background-color: #FFFF16;}
.cython.score-104 {background-color: #FFFF16;}
.cython.score-105 {background-color: #FFFF16;}
.cython.score-106 {background-color: #FFFF15;}
.cython.score-107 {background-color: #FFFF15;}
.cython.score-108 {background-color: #FFFF15;}
.cython.score-109 {background-color: #FFFF15;}
.cython.score-110 {background-color: #FFFF15;}
.cython.score-111 {background-color: #FFFF15;}
.cython.score-112 {background-color: #FFFF14;}
.cython.score-113 {background-color: #FFFF14;}
.cython.score-114 {background-color: #FFFF14;}
.cython.score-115 {background-color: #FFFF14;}
.cython.score-116 {background-color: #FFFF14;}
.cython.score-117 {background-color: #FFFF14;}
.cython.score-118 {background-color: #FFFF13;}
.cython.score-119 {background-color: #FFFF13;}
.cython.score-120 {background-color: #FFFF13;}
.cython.score-121 {background-color: #FFFF13;}
.cython.score-122 {background-color: #FFFF13;}
.cython.score-123 {background-color: #FFFF13;}
.cython.score-124 {background-color: #FFFF13;}
.cython.score-125 {background-color: #FFFF12;}
.cython.score-126 {background-color: #FFFF12;}
.cython.score-127 {background-color: #FFFF12;}
.cython.score-128 {background-color: #FFFF12;}
.cython.score-129 {background-color: #FFFF12;}
.cython.score-130 {background-color: #FFFF12;}
.cython.score-131 {background-color: #FFFF12;}
.cython.score-132 {background-color: #FFFF11;}
.cython.score-133 {background-color: #FFFF11;}
.cython.score-134 {background-color: #FFFF11;}
.cython.score-135 {background-color: #FFFF11;}
.cython.score-136 {background-color: #FFFF11;}
.cython.score-137 {background-color: #FFFF11;}
.cython.score-138 {background-color: #FFFF11;}
.cython.score-139 {background-color: #FFFF11;}
.cython.score-140 {background-color: #FFFF11;}
.cython.score-141 {background-color: #FFFF10;}
.cython.score-142 {background-color: #FFFF10;}
.cython.score-143 {background-color: #FFFF10;}
.cython.score-144 {background-color: #FFFF10;}
.cython.score-145 {background-color: #FFFF10;}
.cython.score-146 {background-color: #FFFF10;}
.cython.score-147 {background-color: #FFFF10;}
.cython.score-148 {background-color: #FFFF10;}
.cython.score-149 {background-color: #FFFF10;}
.cython.score-150 {background-color: #FFFF0f;}
.cython.score-151 {background-color: #FFFF0f;}
.cython.score-152 {background-color: #FFFF0f;}
.cython.score-153 {background-color: #FFFF0f;}
.cython.score-154 {background-color: #FFFF0f;}
.cython.score-155 {background-color: #FFFF0f;}
.cython.score-156 {background-color: #FFFF0f;}
.cython.score-157 {background-color: #FFFF0f;}
.cython.score-158 {background-color: #FFFF0f;}
.cython.score-159 {background-color: #FFFF0f;}
.cython.score-160 {background-color: #FFFF0f;}
.cython.score-161 {background-color: #FFFF0e;}
.cython.score-162 {background-color: #FFFF0e;}
.cython.score-163 {background-color: #FFFF0e;}
.cython.score-164 {background-color: #FFFF0e;}
.cython.score-165 {background-color: #FFFF0e;}
.cython.score-166 {background-color: #FFFF0e;}
.cython.score-167 {background-color: #FFFF0e;}
.cython.score-168 {background-color: #FFFF0e;}
.cython.score-169 {background-color: #FFFF0e;}
.cython.score-170 {background-color: #FFFF0e;}
.cython.score-171 {background-color: #FFFF0e;}
.cython.score-172 {background-color: #FFFF0e;}
.cython.score-173 {background-color: #FFFF0d;}
.cython.score-174 {background-color: #FFFF0d;}
.cython.score-175 {background-color: #FFFF0d;}
.cython.score-176 {background-color: #FFFF0d;}
.cython.score-177 {background-color: #FFFF0d;}
.cython.score-178 {background-color: #FFFF0d;}
.cython.score-179 {background-color: #FFFF0d;}
.cython.score-180 {background-color: #FFFF0d;}
.cython.score-181 {background-color: #FFFF0d;}
.cython.score-182 {background-color: #FFFF0d;}
.cython.score-183 {background-color: #FFFF0d;}
.cython.score-184 {background-color: #FFFF0d;}
.cython.score-185 {background-color: #FFFF0d;}
.cython.score-186 {background-color: #FFFF0d;}
.cython.score-187 {background-color: #FFFF0c;}
.cython.score-188 {background-color: #FFFF0c;}
.cython.score-189 {background-color: #FFFF0c;}
.cython.score-190 {background-color: #FFFF0c;}
.cython.score-191 {background-color: #FFFF0c;}
.cython.score-192 {background-color: #FFFF0c;}
.cython.score-193 {background-color: #FFFF0c;}
.cython.score-194 {background-color: #FFFF0c;}
.cython.score-195 {background-color: #FFFF0c;}
.cython.score-196 {background-color: #FFFF0c;}
.cython.score-197 {background-color: #FFFF0c;}
.cython.score-198 {background-color: #FFFF0c;}
.cython.score-199 {background-color: #FFFF0c;}
.cython.score-200 {background-color: #FFFF0c;}
.cython.score-201 {background-color: #FFFF0c;}
.cython.score-202 {background-color: #FFFF0c;}
.cython.score-203 {background-color: #FFFF0b;}
.cython.score-204 {background-color: #FFFF0b;}
.cython.score-205 {background-color: #FFFF0b;}
.cython.score-206 {background-color: #FFFF0b;}
.cython.score-207 {background-color: #FFFF0b;}
.cython.score-208 {background-color: #FFFF0b;}
.cython.score-209 {background-color: #FFFF0b;}
.cython.score-210 {background-color: #FFFF0b;}
.cython.score-211 {background-color: #FFFF0b;}
.cython.score-212 {background-color: #FFFF0b;}
.cython.score-213 {background-color: #FFFF0b;}
.cython.score-214 {background-color: #FFFF0b;}
.cython.score-215 {background-color: #FFFF0b;}
.cython.score-216 {background-color: #FFFF0b;}
.cython.score-217 {background-color: #FFFF0b;}
.cython.score-218 {background-color: #FFFF0b;}
.cython.score-219 {background-color: #FFFF0b;}
.cython.score-220 {background-color: #FFFF0b;}
.cython.score-221 {background-color: #FFFF0b;}
.cython.score-222 {background-color: #FFFF0a;}
.cython.score-223 {background-color: #FFFF0a;}
.cython.score-224 {background-color: #FFFF0a;}
.cython.score-225 {background-color: #FFFF0a;}
.cython.score-226 {background-color: #FFFF0a;}
.cython.score-227 {background-color: #FFFF0a;}
.cython.score-228 {background-color: #FFFF0a;}
.cython.score-229 {background-color: #FFFF0a;}
.cython.score-230 {background-color: #FFFF0a;}
.cython.score-231 {background-color: #FFFF0a;}
.cython.score-232 {background-color: #FFFF0a;}
.cython.score-233 {background-color: #FFFF0a;}
.cython.score-234 {background-color: #FFFF0a;}
.cython.score-235 {background-color: #FFFF0a;}
.cython.score-236 {background-color: #FFFF0a;}
.cython.score-237 {background-color: #FFFF0a;}
.cython.score-238 {background-color: #FFFF0a;}
.cython.score-239 {background-color: #FFFF0a;}
.cython.score-240 {background-color: #FFFF0a;}
.cython.score-241 {background-color: #FFFF0a;}
.cython.score-242 {background-color: #FFFF0a;}
.cython.score-243 {background-color: #FFFF0a;}
.cython.score-244 {background-color: #FFFF0a;}
.cython.score-245 {background-color: #FFFF0a;}
.cython.score-246 {background-color: #FFFF09;}
.cython.score-247 {background-color: #FFFF09;}
.cython.score-248 {background-color: #FFFF09;}
.cython.score-249 {background-color: #FFFF09;}
.cython.score-250 {background-color: #FFFF09;}
.cython.score-251 {background-color: #FFFF09;}
.cython.score-252 {background-color: #FFFF09;}
.cython.score-253 {background-color: #FFFF09;}
.cython.score-254 {background-color: #FFFF09;}
.cython .hll { background-color: #ffffcc }
.cython  { background: #f8f8f8; }
.cython .c { color: #408080; font-style: italic } /* Comment */
.cython .err { border: 1px solid #FF0000 } /* Error */
.cython .k { color: #008000; font-weight: bold } /* Keyword */
.cython .o { color: #666666 } /* Operator */
.cython .ch { color: #408080; font-style: italic } /* Comment.Hashbang */
.cython .cm { color: #408080; font-style: italic } /* Comment.Multiline */
.cython .cp { color: #BC7A00 } /* Comment.Preproc */
.cython .cpf { color: #408080; font-style: italic } /* Comment.PreprocFile */
.cython .c1 { color: #408080; font-style: italic } /* Comment.Single */
.cython .cs { color: #408080; font-style: italic } /* Comment.Special */
.cython .gd { color: #A00000 } /* Generic.Deleted */
.cython .ge { font-style: italic } /* Generic.Emph */
.cython .gr { color: #FF0000 } /* Generic.Error */
.cython .gh { color: #000080; font-weight: bold } /* Generic.Heading */
.cython .gi { color: #00A000 } /* Generic.Inserted */
.cython .go { color: #888888 } /* Generic.Output */
.cython .gp { color: #000080; font-weight: bold } /* Generic.Prompt */
.cython .gs { font-weight: bold } /* Generic.Strong */
.cython .gu { color: #800080; font-weight: bold } /* Generic.Subheading */
.cython .gt { color: #0044DD } /* Generic.Traceback */
.cython .kc { color: #008000; font-weight: bold } /* Keyword.Constant */
.cython .kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
.cython .kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
.cython .kp { color: #008000 } /* Keyword.Pseudo */
.cython .kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
.cython .kt { color: #B00040 } /* Keyword.Type */
.cython .m { color: #666666 } /* Literal.Number */
.cython .s { color: #BA2121 } /* Literal.String */
.cython .na { color: #7D9029 } /* Name.Attribute */
.cython .nb { color: #008000 } /* Name.Builtin */
.cython .nc { color: #0000FF; font-weight: bold } /* Name.Class */
.cython .no { color: #880000 } /* Name.Constant */
.cython .nd { color: #AA22FF } /* Name.Decorator */
.cython .ni { color: #999999; font-weight: bold } /* Name.Entity */
.cython .ne { color: #D2413A; font-weight: bold } /* Name.Exception */
.cython .nf { color: #0000FF } /* Name.Function */
.cython .nl { color: #A0A000 } /* Name.Label */
.cython .nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
.cython .nt { color: #008000; font-weight: bold } /* Name.Tag */
.cython .nv { color: #19177C } /* Name.Variable */
.cython .ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
.cython .w { color: #bbbbbb } /* Text.Whitespace */
.cython .mb { color: #666666 } /* Literal.Number.Bin */
.cython .mf { color: #666666 } /* Literal.Number.Float */
.cython .mh { color: #666666 } /* Literal.Number.Hex */
.cython .mi { color: #666666 } /* Literal.Number.Integer */
.cython .mo { color: #666666 } /* Literal.Number.Oct */
.cython .sa { color: #BA2121 } /* Literal.String.Affix */
.cython .sb { color: #BA2121 } /* Literal.String.Backtick */
.cython .sc { color: #BA2121 } /* Literal.String.Char */
.cython .dl { color: #BA2121 } /* Literal.String.Delimiter */
.cython .sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
.cython .s2 { color: #BA2121 } /* Literal.String.Double */
.cython .se { color: #BB6622; font-weight: bold } /* Literal.String.Escape */
.cython .sh { color: #BA2121 } /* Literal.String.Heredoc */
.cython .si { color: #BB6688; font-weight: bold } /* Literal.String.Interpol */
.cython .sx { color: #008000 } /* Literal.String.Other */
.cython .sr { color: #BB6688 } /* Literal.String.Regex */
.cython .s1 { color: #BA2121 } /* Literal.String.Single */
.cython .ss { color: #19177C } /* Literal.String.Symbol */
.cython .bp { color: #008000 } /* Name.Builtin.Pseudo */
.cython .fm { color: #0000FF } /* Name.Function.Magic */
.cython .vc { color: #19177C } /* Name.Variable.Class */
.cython .vg { color: #19177C } /* Name.Variable.Global */
.cython .vi { color: #19177C } /* Name.Variable.Instance */
.cython .vm { color: #19177C } /* Name.Variable.Magic */
.cython .il { color: #666666 } /* Literal.Number.Integer.Long */
    </style>
</head>
<body class="cython">
<p><span style="border-bottom: solid 1px grey;">Generated by Cython 0.29.6</span></p>
<p>
    <span style="background-color: #FFFF00">Yellow lines</span> hint at Python interaction.<br />
    Click on a line that starts with a "<code>+</code>" to see the C code that Cython generated for it.
</p>
<p>Raw output: <a href="cubify.c">cubify.c</a></p>
<div class="cython"><pre class="cython line score-8" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">001</span>: <span class="c">#cython: boundscheck=False, wraparound=False, nonecheck=False</span></pre>
<pre class='cython code score-8 '>  __pyx_t_2 = <span class='pyx_c_api'>__Pyx_PyDict_NewPresized</span>(0);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
  if (<span class='py_c_api'>PyDict_SetItem</span>(__pyx_d, __pyx_n_s_test, __pyx_t_2) &lt; 0) <span class='error_goto'>__PYX_ERR(0, 1, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
</pre><pre class="cython line score-0">&#xA0;<span class="">002</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">003</span>: <span class="k">from</span> <span class="nn">libc.math</span> <span class="k">cimport</span> <span class="n">exp</span><span class="p">,</span> <span class="n">sqrt</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">004</span>: </pre>
<pre class="cython line score-8" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">005</span>: <span class="k">import</span> <span class="nn">numpy</span></pre>
<pre class='cython code score-8 '>  __pyx_t_1 = <span class='pyx_c_api'>__Pyx_Import</span>(__pyx_n_s_numpy, 0, -1);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 5, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
  if (<span class='py_c_api'>PyDict_SetItem</span>(__pyx_d, __pyx_n_s_numpy, __pyx_t_1) &lt; 0) <span class='error_goto'>__PYX_ERR(0, 5, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
</pre><pre class="cython line score-0">&#xA0;<span class="">006</span>: <span class="k">cimport</span> <span class="nn">numpy</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">007</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">008</span>: </pre>
<pre class="cython line score-11" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">009</span>: <span class="n">DTYPE</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float32</span></pre>
<pre class='cython code score-11 '>  <span class='pyx_c_api'>__Pyx_GetModuleGlobalName</span>(__pyx_t_1, __pyx_n_s_numpy);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 9, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
  __pyx_t_2 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_t_1, __pyx_n_s_float32);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 9, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
  if (<span class='py_c_api'>PyDict_SetItem</span>(__pyx_d, __pyx_n_s_DTYPE, __pyx_t_2) &lt; 0) <span class='error_goto'>__PYX_ERR(0, 9, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
</pre><pre class="cython line score-0">&#xA0;<span class="">010</span>: <span class="k">ctypedef</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float32_t</span> <span class="n">DTYPE_t</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">011</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">012</span>: </pre>
<pre class="cython line score-104" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">013</span>: <span class="k">def</span> <span class="nf">cubify</span><span class="p">(</span><span class="n">DTYPE_t</span> <span class="p">[:,</span> <span class="p">:]</span> <span class="n">flux</span><span class="p">,</span> <span class="n">DTYPE_t</span> <span class="p">[:,</span> <span class="p">:]</span> <span class="n">ivar</span><span class="p">,</span> <span class="n">DTYPE_t</span> <span class="p">[:,</span> <span class="p">:]</span> <span class="n">xpos</span><span class="p">,</span> <span class="n">DTYPE_t</span> <span class="p">[:,</span> <span class="p">:]</span> <span class="n">ypos</span><span class="p">,</span></pre>
<pre class='cython code score-104 '>/* Python wrapper */
static PyObject *__pyx_pw_5seiya_4cube_6cubify_1cubify(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds); /*proto*/
static char __pyx_doc_5seiya_4cube_6cubify_cubify[] = "Reconstructs a datacube from RSS arrays using the Shepard's algorithm.\n\n    This function follows the approach to cube reconstruction used by MaNGA\n    (see `Law et al. 2016 &lt;http://bit.ly/2M2TmsM&gt;`__). In short, it applies a\n    Shepard's algorithm in which the matrix of weights follows a Gaussian\n    kernel but sets an upper limit to the contribution of a fibre to a point in\n    the grid (``rlimit``). Mathematically,\n\n    .. math::\n\n        w[i,j] = b[i]{\\rm exp}\\left(-0.5\\dfrac{r[i,j]^2}{\\sigma^2} \\right)\n\n    where :math:`r[i,j]=\\sqrt{(x[i]-X[j])^2+(y[i]-Y[j])^2}` is the distance\n    from the :math:`ith` fibre to the :math:`jth` point in the cube grid,\n    :math:`\\sigma` is the exponential scale length, and `b[i]` is zero if the\n    inverse variance for fibre :math:`i` is zero, otherwise one. We make\n    :math:`w[i,j]=0` for all :math:`r[i,j]&gt;r_{\\rm lim}`. For MaNGA,\n    :math:`\\sigma=0.7\\,{\\rm arcsec}` and\n    :math:`r_{\\rm lim}=1.6\\,{\\rm arcsec}`. The weights are normalised as\n\n    .. math::\n\n        W[i,j] = \\dfrac{w[i,j]}{\\sum^{N}_{i=1}w[i,j]}\n\n    where we make :math:`W[i,j]=0` if :math:`w[i,j]=0` for all :math:`i`. The\n    flux for the cube is then calculated as :math:`F=\\alpha W^{T}\\times f`\n    where :math:`f` is the input flux for each fibre and\n    :math:`\\alpha=1/(4\\pi)` accounts for the conversion from flux per unit of\n    area to flux per unit spaxel area.\n\n    The grid is constructed based on the input ``cube_shape``, which determines\n    the number of elements in the x and y dimensions, and the pixel size. The\n    first element in the grid is always :math:`-cube\\_shape \\times pixel\\_size`\n    and the last one :math:`(cube\\_shape - 1) \\times pixel\\_size`.\n\n    If the input ``flux`` and ``ivar`` to this function originate from a MaNGA\n    RSS file (e.g., via the `~seiya.cube.manga_rss_to_cube` function), the\n    output datacube will be almost identical to the MaNGA DRP 3D cubes. The\n   "" small disparities are due to the DRP slightly different handling of masked\n    RSS values. In average, 99.5% of the values in the produced cube are\n    identical to the ones produced by the DRP within a relative tolerance of\n    :math:`10^{-5}`. Only :math:`0.004\\%` of the values differ by more than\n    :math:`10^{-3}` (relative).\n\n    This version assumes that all the inputs and outputs are 32-bit float.\n\n    Parameters\n    ----------\n    flux : `~numpy.ndarray`\n        The flux RSS array in which the first dimension is the fibre and the\n        second is the wavelength.\n    ivar : `~numpy.ndarray`\n        As ``flux`` but for the inverse variance.\n    xpos : `~numpy.ndarray`\n        As ``flux`` but for the x position of the fibre at a given wavelength\n        with respect to the nominal centre of the IFU.\n    ypos : `~numpy.ndarray`\n        Same as ``xpos`` but for the y position.\n    cube_shape : tuple\n        A tuple with two elements indicating the number of spaxels in the x and\n        y directions for the reconstructed cube.\n    pixel_size : float\n        The size of each spaxel, in arcsec. Defaults to 0.5 arcsec, the value\n        used by MaNGA.\n    wsigma : float\n        The exponential scale length for the Shepard's kernel. Defaults to\n        0.7 arcsec, the value used by MaNGA.\n    rlimit : float\n        The cut-off distance at which a fibre does not contribute to the\n        datacube grid. Defaults to 1.6 arcsec, the value used by MaNGA.\n\n    Returns\n    -------\n    datacube : `~numpy.ndarray`\n        A reconstructed 3D datacube in which the first dimension is wavelength,\n        second is y, and third is x.\n\n    ";
static PyMethodDef __pyx_mdef_5seiya_4cube_6cubify_1cubify = {"cubify", (PyCFunction)(void*)(PyCFunctionWithKeywords)__pyx_pw_5seiya_4cube_6cubify_1cubify, METH_VARARGS|METH_KEYWORDS, __pyx_doc_5seiya_4cube_6cubify_cubify};
static PyObject *__pyx_pw_5seiya_4cube_6cubify_1cubify(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds) {
  __Pyx_memviewslice __pyx_v_flux = { 0, 0, { 0 }, { 0 }, { 0 } };
  __Pyx_memviewslice __pyx_v_ivar = { 0, 0, { 0 }, { 0 }, { 0 } };
  __Pyx_memviewslice __pyx_v_xpos = { 0, 0, { 0 }, { 0 }, { 0 } };
  __Pyx_memviewslice __pyx_v_ypos = { 0, 0, { 0 }, { 0 }, { 0 } };
  PyObject *__pyx_v_cube_shape = 0;
  __pyx_t_5seiya_4cube_6cubify_DTYPE_t __pyx_v_pixel_size;
  __pyx_t_5seiya_4cube_6cubify_DTYPE_t __pyx_v_wsigma;
  __pyx_t_5seiya_4cube_6cubify_DTYPE_t __pyx_v_rlimit;
  PyObject *__pyx_r = 0;
  <span class='refnanny'>__Pyx_RefNannyDeclarations</span>
  <span class='refnanny'>__Pyx_RefNannySetupContext</span>("cubify (wrapper)", 0);
  {
    static PyObject **__pyx_pyargnames[] = {&amp;__pyx_n_s_flux,&amp;__pyx_n_s_ivar,&amp;__pyx_n_s_xpos,&amp;__pyx_n_s_ypos,&amp;__pyx_n_s_cube_shape,&amp;__pyx_n_s_pixel_size,&amp;__pyx_n_s_wsigma,&amp;__pyx_n_s_rlimit,0};
    PyObject* values[8] = {0,0,0,0,0,0,0,0};
    if (unlikely(__pyx_kwds)) {
      Py_ssize_t kw_args;
      const Py_ssize_t pos_args = <span class='py_macro_api'>PyTuple_GET_SIZE</span>(__pyx_args);
      switch (pos_args) {
        case  8: values[7] = <span class='py_macro_api'>PyTuple_GET_ITEM</span>(__pyx_args, 7);
        CYTHON_FALLTHROUGH;
        case  7: values[6] = <span class='py_macro_api'>PyTuple_GET_ITEM</span>(__pyx_args, 6);
        CYTHON_FALLTHROUGH;
        case  6: values[5] = <span class='py_macro_api'>PyTuple_GET_ITEM</span>(__pyx_args, 5);
        CYTHON_FALLTHROUGH;
        case  5: values[4] = <span class='py_macro_api'>PyTuple_GET_ITEM</span>(__pyx_args, 4);
        CYTHON_FALLTHROUGH;
        case  4: values[3] = <span class='py_macro_api'>PyTuple_GET_ITEM</span>(__pyx_args, 3);
        CYTHON_FALLTHROUGH;
        case  3: values[2] = <span class='py_macro_api'>PyTuple_GET_ITEM</span>(__pyx_args, 2);
        CYTHON_FALLTHROUGH;
        case  2: values[1] = <span class='py_macro_api'>PyTuple_GET_ITEM</span>(__pyx_args, 1);
        CYTHON_FALLTHROUGH;
        case  1: values[0] = <span class='py_macro_api'>PyTuple_GET_ITEM</span>(__pyx_args, 0);
        CYTHON_FALLTHROUGH;
        case  0: break;
        default: goto __pyx_L5_argtuple_error;
      }
      kw_args = <span class='py_c_api'>PyDict_Size</span>(__pyx_kwds);
      switch (pos_args) {
        case  0:
        if (likely((values[0] = <span class='pyx_c_api'>__Pyx_PyDict_GetItemStr</span>(__pyx_kwds, __pyx_n_s_flux)) != 0)) kw_args--;
        else goto __pyx_L5_argtuple_error;
        CYTHON_FALLTHROUGH;
        case  1:
        if (likely((values[1] = <span class='pyx_c_api'>__Pyx_PyDict_GetItemStr</span>(__pyx_kwds, __pyx_n_s_ivar)) != 0)) kw_args--;
        else {
          <span class='pyx_c_api'>__Pyx_RaiseArgtupleInvalid</span>("cubify", 0, 5, 8, 1); <span class='error_goto'>__PYX_ERR(0, 13, __pyx_L3_error)</span>
        }
        CYTHON_FALLTHROUGH;
        case  2:
        if (likely((values[2] = <span class='pyx_c_api'>__Pyx_PyDict_GetItemStr</span>(__pyx_kwds, __pyx_n_s_xpos)) != 0)) kw_args--;
        else {
          <span class='pyx_c_api'>__Pyx_RaiseArgtupleInvalid</span>("cubify", 0, 5, 8, 2); <span class='error_goto'>__PYX_ERR(0, 13, __pyx_L3_error)</span>
        }
        CYTHON_FALLTHROUGH;
        case  3:
        if (likely((values[3] = <span class='pyx_c_api'>__Pyx_PyDict_GetItemStr</span>(__pyx_kwds, __pyx_n_s_ypos)) != 0)) kw_args--;
        else {
          <span class='pyx_c_api'>__Pyx_RaiseArgtupleInvalid</span>("cubify", 0, 5, 8, 3); <span class='error_goto'>__PYX_ERR(0, 13, __pyx_L3_error)</span>
        }
        CYTHON_FALLTHROUGH;
        case  4:
        if (likely((values[4] = <span class='pyx_c_api'>__Pyx_PyDict_GetItemStr</span>(__pyx_kwds, __pyx_n_s_cube_shape)) != 0)) kw_args--;
        else {
          <span class='pyx_c_api'>__Pyx_RaiseArgtupleInvalid</span>("cubify", 0, 5, 8, 4); <span class='error_goto'>__PYX_ERR(0, 13, __pyx_L3_error)</span>
        }
        CYTHON_FALLTHROUGH;
        case  5:
        if (kw_args &gt; 0) {
          PyObject* value = <span class='pyx_c_api'>__Pyx_PyDict_GetItemStr</span>(__pyx_kwds, __pyx_n_s_pixel_size);
          if (value) { values[5] = value; kw_args--; }
        }
        CYTHON_FALLTHROUGH;
        case  6:
        if (kw_args &gt; 0) {
          PyObject* value = <span class='pyx_c_api'>__Pyx_PyDict_GetItemStr</span>(__pyx_kwds, __pyx_n_s_wsigma);
          if (value) { values[6] = value; kw_args--; }
        }
        CYTHON_FALLTHROUGH;
        case  7:
        if (kw_args &gt; 0) {
          PyObject* value = <span class='pyx_c_api'>__Pyx_PyDict_GetItemStr</span>(__pyx_kwds, __pyx_n_s_rlimit);
          if (value) { values[7] = value; kw_args--; }
        }
      }
      if (unlikely(kw_args &gt; 0)) {
        if (unlikely(<span class='pyx_c_api'>__Pyx_ParseOptionalKeywords</span>(__pyx_kwds, __pyx_pyargnames, 0, values, pos_args, "cubify") &lt; 0)) <span class='error_goto'>__PYX_ERR(0, 13, __pyx_L3_error)</span>
      }
    } else {
      switch (<span class='py_macro_api'>PyTuple_GET_SIZE</span>(__pyx_args)) {
        case  8: values[7] = <span class='py_macro_api'>PyTuple_GET_ITEM</span>(__pyx_args, 7);
        CYTHON_FALLTHROUGH;
        case  7: values[6] = <span class='py_macro_api'>PyTuple_GET_ITEM</span>(__pyx_args, 6);
        CYTHON_FALLTHROUGH;
        case  6: values[5] = <span class='py_macro_api'>PyTuple_GET_ITEM</span>(__pyx_args, 5);
        CYTHON_FALLTHROUGH;
        case  5: values[4] = <span class='py_macro_api'>PyTuple_GET_ITEM</span>(__pyx_args, 4);
        values[3] = <span class='py_macro_api'>PyTuple_GET_ITEM</span>(__pyx_args, 3);
        values[2] = <span class='py_macro_api'>PyTuple_GET_ITEM</span>(__pyx_args, 2);
        values[1] = <span class='py_macro_api'>PyTuple_GET_ITEM</span>(__pyx_args, 1);
        values[0] = <span class='py_macro_api'>PyTuple_GET_ITEM</span>(__pyx_args, 0);
        break;
        default: goto __pyx_L5_argtuple_error;
      }
    }
    __pyx_v_flux = __Pyx_PyObject_to_MemoryviewSlice_dsds_nn___pyx_t_5seiya_4cube_6cubify_DTYPE_t(values[0], PyBUF_WRITABLE);<span class='error_goto'> if (unlikely(!__pyx_v_flux.memview)) __PYX_ERR(0, 13, __pyx_L3_error)</span>
    __pyx_v_ivar = __Pyx_PyObject_to_MemoryviewSlice_dsds_nn___pyx_t_5seiya_4cube_6cubify_DTYPE_t(values[1], PyBUF_WRITABLE);<span class='error_goto'> if (unlikely(!__pyx_v_ivar.memview)) __PYX_ERR(0, 13, __pyx_L3_error)</span>
    __pyx_v_xpos = __Pyx_PyObject_to_MemoryviewSlice_dsds_nn___pyx_t_5seiya_4cube_6cubify_DTYPE_t(values[2], PyBUF_WRITABLE);<span class='error_goto'> if (unlikely(!__pyx_v_xpos.memview)) __PYX_ERR(0, 13, __pyx_L3_error)</span>
    __pyx_v_ypos = __Pyx_PyObject_to_MemoryviewSlice_dsds_nn___pyx_t_5seiya_4cube_6cubify_DTYPE_t(values[3], PyBUF_WRITABLE);<span class='error_goto'> if (unlikely(!__pyx_v_ypos.memview)) __PYX_ERR(0, 13, __pyx_L3_error)</span>
    __pyx_v_cube_shape = values[4];
    if (values[5]) {
      __pyx_v_pixel_size = __pyx_<span class='py_c_api'>PyFloat_AsFloat</span>(values[5]); if (unlikely((__pyx_v_pixel_size == ((npy_float32)-1)) &amp;&amp; <span class='py_c_api'>PyErr_Occurred</span>())) <span class='error_goto'>__PYX_ERR(0, 14, __pyx_L3_error)</span>
    } else {
      __pyx_v_pixel_size = ((__pyx_t_5seiya_4cube_6cubify_DTYPE_t)0.5);
    }
    if (values[6]) {
      __pyx_v_wsigma = __pyx_<span class='py_c_api'>PyFloat_AsFloat</span>(values[6]); if (unlikely((__pyx_v_wsigma == ((npy_float32)-1)) &amp;&amp; <span class='py_c_api'>PyErr_Occurred</span>())) <span class='error_goto'>__PYX_ERR(0, 14, __pyx_L3_error)</span>
    } else {
      __pyx_v_wsigma = ((__pyx_t_5seiya_4cube_6cubify_DTYPE_t)0.7);
    }
    if (values[7]) {
      __pyx_v_rlimit = __pyx_<span class='py_c_api'>PyFloat_AsFloat</span>(values[7]); if (unlikely((__pyx_v_rlimit == ((npy_float32)-1)) &amp;&amp; <span class='py_c_api'>PyErr_Occurred</span>())) <span class='error_goto'>__PYX_ERR(0, 14, __pyx_L3_error)</span>
    } else {
      __pyx_v_rlimit = ((__pyx_t_5seiya_4cube_6cubify_DTYPE_t)1.6);
    }
  }
  goto __pyx_L4_argument_unpacking_done;
  __pyx_L5_argtuple_error:;
  <span class='pyx_c_api'>__Pyx_RaiseArgtupleInvalid</span>("cubify", 0, 5, 8, <span class='py_macro_api'>PyTuple_GET_SIZE</span>(__pyx_args)); <span class='error_goto'>__PYX_ERR(0, 13, __pyx_L3_error)</span>
  __pyx_L3_error:;
  <span class='pyx_c_api'>__Pyx_AddTraceback</span>("seiya.cube.cubify.cubify", __pyx_clineno, __pyx_lineno, __pyx_filename);
  <span class='refnanny'>__Pyx_RefNannyFinishContext</span>();
  return NULL;
  __pyx_L4_argument_unpacking_done:;
  __pyx_r = __pyx_pf_5seiya_4cube_6cubify_cubify(__pyx_self, __pyx_v_flux, __pyx_v_ivar, __pyx_v_xpos, __pyx_v_ypos, __pyx_v_cube_shape, __pyx_v_pixel_size, __pyx_v_wsigma, __pyx_v_rlimit);

  /* function exit code */
  <span class='refnanny'>__Pyx_RefNannyFinishContext</span>();
  return __pyx_r;
}

static PyObject *__pyx_pf_5seiya_4cube_6cubify_cubify(CYTHON_UNUSED PyObject *__pyx_self, __Pyx_memviewslice __pyx_v_flux, __Pyx_memviewslice __pyx_v_ivar, __Pyx_memviewslice __pyx_v_xpos, __Pyx_memviewslice __pyx_v_ypos, PyObject *__pyx_v_cube_shape, __pyx_t_5seiya_4cube_6cubify_DTYPE_t __pyx_v_pixel_size, __pyx_t_5seiya_4cube_6cubify_DTYPE_t __pyx_v_wsigma, __pyx_t_5seiya_4cube_6cubify_DTYPE_t __pyx_v_rlimit) {
  Py_ssize_t __pyx_v_iwave;
  Py_ssize_t __pyx_v_ifibre;
  Py_ssize_t __pyx_v_ii;
  Py_ssize_t __pyx_v_jj;
  __pyx_t_5seiya_4cube_6cubify_DTYPE_t __pyx_v_fibre_xpos;
  __pyx_t_5seiya_4cube_6cubify_DTYPE_t __pyx_v_fibre_ypos;
  __pyx_t_5seiya_4cube_6cubify_DTYPE_t __pyx_v_X_test;
  __pyx_t_5seiya_4cube_6cubify_DTYPE_t __pyx_v_Y_test;
  Py_ssize_t __pyx_v_nfibres;
  Py_ssize_t __pyx_v_nwave;
  __pyx_t_5seiya_4cube_6cubify_DTYPE_t __pyx_v_alpha;
  __pyx_t_5seiya_4cube_6cubify_DTYPE_t __pyx_v_exp_coeff;
  __pyx_t_5seiya_4cube_6cubify_DTYPE_t __pyx_v_rlimit2;
  __pyx_t_5seiya_4cube_6cubify_DTYPE_t __pyx_v_window_seach_size;
  Py_ssize_t __pyx_v_X_shape;
  Py_ssize_t __pyx_v_Y_shape;
  __Pyx_memviewslice __pyx_v_X_range = { 0, 0, { 0 }, { 0 }, { 0 } };
  __Pyx_memviewslice __pyx_v_Y_range = { 0, 0, { 0 }, { 0 }, { 0 } };
  __Pyx_memviewslice __pyx_v_F_j = { 0, 0, { 0 }, { 0 }, { 0 } };
  __Pyx_memviewslice __pyx_v_w_ij = { 0, 0, { 0 }, { 0 }, { 0 } };
  __pyx_t_5seiya_4cube_6cubify_DTYPE_t __pyx_v_r2_ij;
  __pyx_t_5seiya_4cube_6cubify_DTYPE_t __pyx_v_w_sum;
  __Pyx_memviewslice __pyx_v_F_ijw = { 0, 0, { 0 }, { 0 }, { 0 } };
  PyObject *__pyx_r = NULL;
  <span class='refnanny'>__Pyx_RefNannyDeclarations</span>
  <span class='refnanny'>__Pyx_RefNannySetupContext</span>("cubify", 0);
/* … */
  /* function exit code */
  __pyx_L1_error:;
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_1);
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_2);
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_4);
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_8);
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_9);
  __PYX_XDEC_MEMVIEW(&amp;__pyx_t_10, 1);
  __PYX_XDEC_MEMVIEW(&amp;__pyx_t_11, 1);
  __PYX_XDEC_MEMVIEW(&amp;__pyx_t_13, 1);
  <span class='pyx_c_api'>__Pyx_AddTraceback</span>("seiya.cube.cubify.cubify", __pyx_clineno, __pyx_lineno, __pyx_filename);
  __pyx_r = NULL;
  __pyx_L0:;
  __PYX_XDEC_MEMVIEW(&amp;__pyx_v_X_range, 1);
  __PYX_XDEC_MEMVIEW(&amp;__pyx_v_Y_range, 1);
  __PYX_XDEC_MEMVIEW(&amp;__pyx_v_F_j, 1);
  __PYX_XDEC_MEMVIEW(&amp;__pyx_v_w_ij, 1);
  __PYX_XDEC_MEMVIEW(&amp;__pyx_v_F_ijw, 1);
  __PYX_XDEC_MEMVIEW(&amp;__pyx_v_flux, 1);
  __PYX_XDEC_MEMVIEW(&amp;__pyx_v_ivar, 1);
  __PYX_XDEC_MEMVIEW(&amp;__pyx_v_xpos, 1);
  __PYX_XDEC_MEMVIEW(&amp;__pyx_v_ypos, 1);
  <span class='refnanny'>__Pyx_XGIVEREF</span>(__pyx_r);
  <span class='refnanny'>__Pyx_RefNannyFinishContext</span>();
  return __pyx_r;
}
/* … */
  __pyx_tuple__26 = <span class='py_c_api'>PyTuple_Pack</span>(33, __pyx_n_s_flux, __pyx_n_s_ivar, __pyx_n_s_xpos, __pyx_n_s_ypos, __pyx_n_s_cube_shape, __pyx_n_s_pixel_size, __pyx_n_s_wsigma, __pyx_n_s_rlimit, __pyx_n_s_iwave, __pyx_n_s_ifibre, __pyx_n_s_ii, __pyx_n_s_jj, __pyx_n_s_kk, __pyx_n_s_idx, __pyx_n_s_fibre_xpos, __pyx_n_s_fibre_ypos, __pyx_n_s_X_test, __pyx_n_s_Y_test, __pyx_n_s_nfibres, __pyx_n_s_nwave, __pyx_n_s_alpha, __pyx_n_s_exp_coeff, __pyx_n_s_rlimit2, __pyx_n_s_window_seach_size, __pyx_n_s_X_shape, __pyx_n_s_Y_shape, __pyx_n_s_X_range, __pyx_n_s_Y_range, __pyx_n_s_F_j, __pyx_n_s_w_ij, __pyx_n_s_r2_ij, __pyx_n_s_w_sum, __pyx_n_s_F_ijw);<span class='error_goto'> if (unlikely(!__pyx_tuple__26)) __PYX_ERR(0, 13, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_tuple__26);
  <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_tuple__26);
/* … */
  __pyx_t_2 = PyCFunction_NewEx(&amp;__pyx_mdef_5seiya_4cube_6cubify_1cubify, NULL, __pyx_n_s_seiya_cube_cubify);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 13, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
  if (<span class='py_c_api'>PyDict_SetItem</span>(__pyx_d, __pyx_n_s_cubify, __pyx_t_2) &lt; 0) <span class='error_goto'>__PYX_ERR(0, 13, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
  __pyx_codeobj__27 = (PyObject*)<span class='pyx_c_api'>__Pyx_PyCode_New</span>(8, 0, 33, 0, CO_OPTIMIZED|CO_NEWLOCALS, __pyx_empty_bytes, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_tuple__26, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_kp_s_seiya_cube_cubify_pyx, __pyx_n_s_cubify, 13, __pyx_empty_bytes);<span class='error_goto'> if (unlikely(!__pyx_codeobj__27)) __PYX_ERR(0, 13, __pyx_L1_error)</span>
</pre><pre class="cython line score-0">&#xA0;<span class="">014</span>:            <span class="n">cube_shape</span><span class="p">,</span> <span class="n">DTYPE_t</span> <span class="n">pixel_size</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">DTYPE_t</span> <span class="n">wsigma</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">DTYPE_t</span> <span class="n">rlimit</span><span class="o">=</span><span class="mf">1.6</span><span class="p">):</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">015</span>:     <span class="s">r&quot;&quot;&quot;Reconstructs a datacube from RSS arrays using the Shepard&#39;s algorithm.</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">016</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">017</span>: <span class="s">    This function follows the approach to cube reconstruction used by MaNGA</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">018</span>: <span class="s">    (see `Law et al. 2016 &lt;http://bit.ly/2M2TmsM&gt;`__). In short, it applies a</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">019</span>: <span class="s">    Shepard&#39;s algorithm in which the matrix of weights follows a Gaussian</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">020</span>: <span class="s">    kernel but sets an upper limit to the contribution of a fibre to a point in</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">021</span>: <span class="s">    the grid (``rlimit``). Mathematically,</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">022</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">023</span>: <span class="s">    .. math::</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">024</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">025</span>: <span class="s">        w[i,j] = b[i]{\rm exp}\left(-0.5\dfrac{r[i,j]^2}{\sigma^2} \right)</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">026</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">027</span>: <span class="s">    where :math:`r[i,j]=\sqrt{(x[i]-X[j])^2+(y[i]-Y[j])^2}` is the distance</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">028</span>: <span class="s">    from the :math:`ith` fibre to the :math:`jth` point in the cube grid,</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">029</span>: <span class="s">    :math:`\sigma` is the exponential scale length, and `b[i]` is zero if the</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">030</span>: <span class="s">    inverse variance for fibre :math:`i` is zero, otherwise one. We make</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">031</span>: <span class="s">    :math:`w[i,j]=0` for all :math:`r[i,j]&gt;r_{\rm lim}`. For MaNGA,</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">032</span>: <span class="s">    :math:`\sigma=0.7\,{\rm arcsec}` and</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">033</span>: <span class="s">    :math:`r_{\rm lim}=1.6\,{\rm arcsec}`. The weights are normalised as</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">034</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">035</span>: <span class="s">    .. math::</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">036</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">037</span>: <span class="s">        W[i,j] = \dfrac{w[i,j]}{\sum^{N}_{i=1}w[i,j]}</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">038</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">039</span>: <span class="s">    where we make :math:`W[i,j]=0` if :math:`w[i,j]=0` for all :math:`i`. The</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">040</span>: <span class="s">    flux for the cube is then calculated as :math:`F=\alpha W^{T}\times f`</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">041</span>: <span class="s">    where :math:`f` is the input flux for each fibre and</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">042</span>: <span class="s">    :math:`\alpha=1/(4\pi)` accounts for the conversion from flux per unit of</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">043</span>: <span class="s">    area to flux per unit spaxel area.</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">044</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">045</span>: <span class="s">    The grid is constructed based on the input ``cube_shape``, which determines</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">046</span>: <span class="s">    the number of elements in the x and y dimensions, and the pixel size. The</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">047</span>: <span class="s">    first element in the grid is always :math:`-cube\_shape \times pixel\_size`</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">048</span>: <span class="s">    and the last one :math:`(cube\_shape - 1) \times pixel\_size`.</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">049</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">050</span>: <span class="s">    If the input ``flux`` and ``ivar`` to this function originate from a MaNGA</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">051</span>: <span class="s">    RSS file (e.g., via the `~seiya.cube.manga_rss_to_cube` function), the</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">052</span>: <span class="s">    output datacube will be almost identical to the MaNGA DRP 3D cubes. The</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">053</span>: <span class="s">    small disparities are due to the DRP slightly different handling of masked</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">054</span>: <span class="s">    RSS values. In average, 99.5</span><span class="si">% o</span><span class="s">f the values in the produced cube are</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">055</span>: <span class="s">    identical to the ones produced by the DRP within a relative tolerance of</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">056</span>: <span class="s">    :math:`10^{-5}`. Only :math:`0.004\%` of the values differ by more than</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">057</span>: <span class="s">    :math:`10^{-3}` (relative).</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">058</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">059</span>: <span class="s">    This version assumes that all the inputs and outputs are 32-bit float.</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">060</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">061</span>: <span class="s">    Parameters</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">062</span>: <span class="s">    ----------</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">063</span>: <span class="s">    flux : `~numpy.ndarray`</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">064</span>: <span class="s">        The flux RSS array in which the first dimension is the fibre and the</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">065</span>: <span class="s">        second is the wavelength.</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">066</span>: <span class="s">    ivar : `~numpy.ndarray`</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">067</span>: <span class="s">        As ``flux`` but for the inverse variance.</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">068</span>: <span class="s">    xpos : `~numpy.ndarray`</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">069</span>: <span class="s">        As ``flux`` but for the x position of the fibre at a given wavelength</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">070</span>: <span class="s">        with respect to the nominal centre of the IFU.</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">071</span>: <span class="s">    ypos : `~numpy.ndarray`</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">072</span>: <span class="s">        Same as ``xpos`` but for the y position.</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">073</span>: <span class="s">    cube_shape : tuple</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">074</span>: <span class="s">        A tuple with two elements indicating the number of spaxels in the x and</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">075</span>: <span class="s">        y directions for the reconstructed cube.</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">076</span>: <span class="s">    pixel_size : float</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">077</span>: <span class="s">        The size of each spaxel, in arcsec. Defaults to 0.5 arcsec, the value</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">078</span>: <span class="s">        used by MaNGA.</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">079</span>: <span class="s">    wsigma : float</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">080</span>: <span class="s">        The exponential scale length for the Shepard&#39;s kernel. Defaults to</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">081</span>: <span class="s">        0.7 arcsec, the value used by MaNGA.</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">082</span>: <span class="s">    rlimit : float</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">083</span>: <span class="s">        The cut-off distance at which a fibre does not contribute to the</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">084</span>: <span class="s">        datacube grid. Defaults to 1.6 arcsec, the value used by MaNGA.</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">085</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">086</span>: <span class="s">    Returns</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">087</span>: <span class="s">    -------</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">088</span>: <span class="s">    datacube : `~numpy.ndarray`</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">089</span>: <span class="s">        A reconstructed 3D datacube in which the first dimension is wavelength,</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">090</span>: <span class="s">        second is y, and third is x.</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">091</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">092</span>: <span class="s">    &quot;&quot;&quot;</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">093</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">094</span>:     <span class="c"># Define array shapes and several indexing variables</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">095</span>:     <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">iwave</span><span class="p">,</span> <span class="nf">ifibre</span><span class="p">,</span> <span class="nf">ii</span><span class="p">,</span> <span class="nf">jj</span><span class="p">,</span> <span class="nf">kk</span><span class="p">,</span> <span class="nf">idx</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">096</span>:     <span class="k">cdef</span> <span class="kt">DTYPE_t</span> <span class="nf">fibre_xpos</span><span class="p">,</span> <span class="nf">fibre_ypos</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">097</span>:     <span class="k">cdef</span> <span class="kt">DTYPE_t</span> <span class="nf">X_test</span><span class="p">,</span> <span class="nf">Y_test</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">098</span>: </pre>
<pre class="cython line score-0" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">099</span>:     <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">nfibres</span> <span class="o">=</span> <span class="n">flux</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span></pre>
<pre class='cython code score-0 '>  __pyx_v_nfibres = (__pyx_v_flux.shape[0]);
</pre><pre class="cython line score-0" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">100</span>:     <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">nwave</span> <span class="o">=</span> <span class="n">flux</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">1</span><span class="p">]</span></pre>
<pre class='cython code score-0 '>  __pyx_v_nwave = (__pyx_v_flux.shape[1]);
</pre><pre class="cython line score-0">&#xA0;<span class="">101</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">102</span>:     <span class="c"># Defines some constants that we&#39;ll use later</span></pre>
<pre class="cython line score-25" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">103</span>:     <span class="k">cdef</span> <span class="kt">DTYPE_t</span> <span class="nf">alpha</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">/</span> <span class="p">(</span><span class="mf">4.</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span></pre>
<pre class='cython code score-25 '>  <span class='pyx_c_api'>__Pyx_GetModuleGlobalName</span>(__pyx_t_1, __pyx_n_s_numpy);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 103, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
  __pyx_t_2 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_t_1, __pyx_n_s_pi);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 103, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
  __pyx_t_1 = <span class='py_c_api'>PyNumber_Multiply</span>(__pyx_float_4_, __pyx_t_2);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 103, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
  __pyx_t_2 = <span class='pyx_c_api'>__Pyx_PyFloat_DivideCObj</span>(__pyx_float_1_, __pyx_t_1, 1., 0, 1);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 103, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
  __pyx_t_3 = __pyx_<span class='py_c_api'>PyFloat_AsFloat</span>(__pyx_t_2); if (unlikely((__pyx_t_3 == ((npy_float32)-1)) &amp;&amp; <span class='py_c_api'>PyErr_Occurred</span>())) <span class='error_goto'>__PYX_ERR(0, 103, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
  __pyx_v_alpha = __pyx_t_3;
</pre><pre class="cython line score-5" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">104</span>:     <span class="k">cdef</span> <span class="kt">DTYPE_t</span> <span class="nf">exp_coeff</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span> <span class="o">/</span> <span class="n">wsigma</span><span class="o">**</span><span class="mf">2</span></pre>
<pre class='cython code score-5 '>  __pyx_t_3 = powf(__pyx_v_wsigma, 2.0);
  if (unlikely(__pyx_t_3 == 0)) {
    <span class='py_c_api'>PyErr_SetString</span>(PyExc_ZeroDivisionError, "float division");
    <span class='error_goto'>__PYX_ERR(0, 104, __pyx_L1_error)</span>
  }
  __pyx_v_exp_coeff = (-0.5 / __pyx_t_3);
</pre><pre class="cython line score-0" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">105</span>:     <span class="k">cdef</span> <span class="kt">DTYPE_t</span> <span class="nf">rlimit2</span> <span class="o">=</span> <span class="n">rlimit</span><span class="o">**</span><span class="mf">2</span></pre>
<pre class='cython code score-0 '>  __pyx_v_rlimit2 = powf(__pyx_v_rlimit, 2.0);
</pre><pre class="cython line score-0" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">106</span>:     <span class="k">cdef</span> <span class="kt">DTYPE_t</span> <span class="nf">window_seach_size</span> <span class="o">=</span> <span class="n">rlimit</span> <span class="o">+</span> <span class="n">pixel_size</span></pre>
<pre class='cython code score-0 '>  __pyx_v_window_seach_size = (__pyx_v_rlimit + __pyx_v_pixel_size);
</pre><pre class="cython line score-0">&#xA0;<span class="">107</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">108</span>:     <span class="c"># Assigns the shape of the grid from the input tuple.</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">109</span>:     <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">X_shape</span><span class="p">,</span> <span class="nf">Y_shape</span></pre>
<pre class="cython line score-58" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">110</span>:     <span class="n">X_shape</span><span class="p">,</span> <span class="n">Y_shape</span> <span class="o">=</span> <span class="n">cube_shape</span></pre>
<pre class='cython code score-58 '>  if ((likely(<span class='py_c_api'>PyTuple_CheckExact</span>(__pyx_v_cube_shape))) || (<span class='py_c_api'>PyList_CheckExact</span>(__pyx_v_cube_shape))) {
    PyObject* sequence = __pyx_v_cube_shape;
    Py_ssize_t size = <span class='pyx_c_api'>__Pyx_PySequence_SIZE</span>(sequence);
    if (unlikely(size != 2)) {
      if (size &gt; 2) <span class='pyx_c_api'>__Pyx_RaiseTooManyValuesError</span>(2);
      else if (size &gt;= 0) <span class='pyx_c_api'>__Pyx_RaiseNeedMoreValuesError</span>(size);
      <span class='error_goto'>__PYX_ERR(0, 110, __pyx_L1_error)</span>
    }
    #if CYTHON_ASSUME_SAFE_MACROS &amp;&amp; !CYTHON_AVOID_BORROWED_REFS
    if (likely(<span class='py_c_api'>PyTuple_CheckExact</span>(sequence))) {
      __pyx_t_2 = <span class='py_macro_api'>PyTuple_GET_ITEM</span>(sequence, 0); 
      __pyx_t_1 = <span class='py_macro_api'>PyTuple_GET_ITEM</span>(sequence, 1); 
    } else {
      __pyx_t_2 = <span class='py_macro_api'>PyList_GET_ITEM</span>(sequence, 0); 
      __pyx_t_1 = <span class='py_macro_api'>PyList_GET_ITEM</span>(sequence, 1); 
    }
    <span class='pyx_macro_api'>__Pyx_INCREF</span>(__pyx_t_2);
    <span class='pyx_macro_api'>__Pyx_INCREF</span>(__pyx_t_1);
    #else
    __pyx_t_2 = <span class='py_macro_api'>PySequence_ITEM</span>(sequence, 0);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 110, __pyx_L1_error)</span>
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
    __pyx_t_1 = <span class='py_macro_api'>PySequence_ITEM</span>(sequence, 1);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 110, __pyx_L1_error)</span>
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
    #endif
  } else {
    Py_ssize_t index = -1;
    __pyx_t_4 = <span class='py_c_api'>PyObject_GetIter</span>(__pyx_v_cube_shape);<span class='error_goto'> if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 110, __pyx_L1_error)</span>
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_4);
    __pyx_t_5 = Py_TYPE(__pyx_t_4)-&gt;tp_iternext;
    index = 0; __pyx_t_2 = __pyx_t_5(__pyx_t_4); if (unlikely(!__pyx_t_2)) goto __pyx_L3_unpacking_failed;
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
    index = 1; __pyx_t_1 = __pyx_t_5(__pyx_t_4); if (unlikely(!__pyx_t_1)) goto __pyx_L3_unpacking_failed;
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
    if (<span class='pyx_c_api'>__Pyx_IternextUnpackEndCheck</span>(__pyx_t_5(__pyx_t_4), 2) &lt; 0) <span class='error_goto'>__PYX_ERR(0, 110, __pyx_L1_error)</span>
    __pyx_t_5 = NULL;
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_4); __pyx_t_4 = 0;
    goto __pyx_L4_unpacking_done;
    __pyx_L3_unpacking_failed:;
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_4); __pyx_t_4 = 0;
    __pyx_t_5 = NULL;
    if (<span class='pyx_c_api'>__Pyx_IterFinish</span>() == 0) <span class='pyx_c_api'>__Pyx_RaiseNeedMoreValuesError</span>(index);
    <span class='error_goto'>__PYX_ERR(0, 110, __pyx_L1_error)</span>
    __pyx_L4_unpacking_done:;
  }
  __pyx_t_6 = <span class='pyx_c_api'>__Pyx_PyIndex_AsSsize_t</span>(__pyx_t_2); if (unlikely((__pyx_t_6 == (Py_ssize_t)-1) &amp;&amp; <span class='py_c_api'>PyErr_Occurred</span>())) <span class='error_goto'>__PYX_ERR(0, 110, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
  __pyx_t_7 = <span class='pyx_c_api'>__Pyx_PyIndex_AsSsize_t</span>(__pyx_t_1); if (unlikely((__pyx_t_7 == (Py_ssize_t)-1) &amp;&amp; <span class='py_c_api'>PyErr_Occurred</span>())) <span class='error_goto'>__PYX_ERR(0, 110, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
  __pyx_v_X_shape = __pyx_t_6;
  __pyx_v_Y_shape = __pyx_t_7;
</pre><pre class="cython line score-0">&#xA0;<span class="">111</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">112</span>:     <span class="c"># Creates the array of positions on the grid, in x and y.</span></pre>
<pre class="cython line score-24" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">113</span>:     <span class="k">cdef</span> <span class="kt">DTYPE_t</span> [<span class="p">:]</span> <span class="n">X_range</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="n">X_shape</span> <span class="o">*</span> <span class="n">pixel_size</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">,</span></pre>
<pre class='cython code score-24 '>  <span class='pyx_c_api'>__Pyx_GetModuleGlobalName</span>(__pyx_t_1, __pyx_n_s_numpy);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 113, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
  __pyx_t_2 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_t_1, __pyx_n_s_arange);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 113, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
  __pyx_t_1 = <span class='py_c_api'>PyFloat_FromDouble</span>((((-__pyx_v_X_shape) * __pyx_v_pixel_size) / 2.));<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 113, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
/* … */
  __pyx_t_9 = <span class='py_c_api'>PyTuple_New</span>(3);<span class='error_goto'> if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 113, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_9);
  <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_t_1);
  <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_9, 0, __pyx_t_1);
  <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_t_4);
  <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_9, 1, __pyx_t_4);
  <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_t_8);
  <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_9, 2, __pyx_t_8);
  __pyx_t_1 = 0;
  __pyx_t_4 = 0;
  __pyx_t_8 = 0;
/* … */
  __pyx_t_4 = <span class='pyx_c_api'>__Pyx_PyObject_Call</span>(__pyx_t_2, __pyx_t_9, __pyx_t_8);<span class='error_goto'> if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 113, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_4);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_9); __pyx_t_9 = 0;
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_8); __pyx_t_8 = 0;
  __pyx_t_10 = __Pyx_PyObject_to_MemoryviewSlice_ds_nn___pyx_t_5seiya_4cube_6cubify_DTYPE_t(__pyx_t_4, PyBUF_WRITABLE);<span class='error_goto'> if (unlikely(!__pyx_t_10.memview)) __PYX_ERR(0, 113, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_4); __pyx_t_4 = 0;
  __pyx_v_X_range = __pyx_t_10;
  __pyx_t_10.memview = NULL;
  __pyx_t_10.data = NULL;
</pre><pre class="cython line score-5" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">114</span>:                                             <span class="n">X_shape</span> <span class="o">*</span> <span class="n">pixel_size</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">,</span></pre>
<pre class='cython code score-5 '>  __pyx_t_4 = <span class='py_c_api'>PyFloat_FromDouble</span>(((__pyx_v_X_shape * __pyx_v_pixel_size) / 2.));<span class='error_goto'> if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 114, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_4);
</pre><pre class="cython line score-15" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">115</span>:                                             <span class="n">pixel_size</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">DTYPE</span><span class="p">)</span></pre>
<pre class='cython code score-15 '>  __pyx_t_8 = <span class='py_c_api'>PyFloat_FromDouble</span>(__pyx_v_pixel_size);<span class='error_goto'> if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 115, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_8);
/* … */
  __pyx_t_8 = <span class='pyx_c_api'>__Pyx_PyDict_NewPresized</span>(1);<span class='error_goto'> if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 115, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_8);
  <span class='pyx_c_api'>__Pyx_GetModuleGlobalName</span>(__pyx_t_4, __pyx_n_s_DTYPE);<span class='error_goto'> if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 115, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_4);
  if (<span class='py_c_api'>PyDict_SetItem</span>(__pyx_t_8, __pyx_n_s_dtype, __pyx_t_4) &lt; 0) <span class='error_goto'>__PYX_ERR(0, 115, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_4); __pyx_t_4 = 0;
</pre><pre class="cython line score-24" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">116</span>:     <span class="k">cdef</span> <span class="kt">DTYPE_t</span> [<span class="p">:]</span> <span class="n">Y_range</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="n">Y_shape</span> <span class="o">*</span> <span class="n">pixel_size</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">,</span></pre>
<pre class='cython code score-24 '>  <span class='pyx_c_api'>__Pyx_GetModuleGlobalName</span>(__pyx_t_4, __pyx_n_s_numpy);<span class='error_goto'> if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 116, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_4);
  __pyx_t_8 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_t_4, __pyx_n_s_arange);<span class='error_goto'> if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 116, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_8);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_4); __pyx_t_4 = 0;
  __pyx_t_4 = <span class='py_c_api'>PyFloat_FromDouble</span>((((-__pyx_v_Y_shape) * __pyx_v_pixel_size) / 2.));<span class='error_goto'> if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 116, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_4);
/* … */
  __pyx_t_1 = <span class='py_c_api'>PyTuple_New</span>(3);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 116, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
  <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_t_4);
  <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_1, 0, __pyx_t_4);
  <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_t_9);
  <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_1, 1, __pyx_t_9);
  <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_t_2);
  <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_1, 2, __pyx_t_2);
  __pyx_t_4 = 0;
  __pyx_t_9 = 0;
  __pyx_t_2 = 0;
/* … */
  __pyx_t_9 = <span class='pyx_c_api'>__Pyx_PyObject_Call</span>(__pyx_t_8, __pyx_t_1, __pyx_t_2);<span class='error_goto'> if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 116, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_9);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_8); __pyx_t_8 = 0;
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
  __pyx_t_10 = __Pyx_PyObject_to_MemoryviewSlice_ds_nn___pyx_t_5seiya_4cube_6cubify_DTYPE_t(__pyx_t_9, PyBUF_WRITABLE);<span class='error_goto'> if (unlikely(!__pyx_t_10.memview)) __PYX_ERR(0, 116, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_9); __pyx_t_9 = 0;
  __pyx_v_Y_range = __pyx_t_10;
  __pyx_t_10.memview = NULL;
  __pyx_t_10.data = NULL;
</pre><pre class="cython line score-5" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">117</span>:                                             <span class="n">Y_shape</span> <span class="o">*</span> <span class="n">pixel_size</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">,</span></pre>
<pre class='cython code score-5 '>  __pyx_t_9 = <span class='py_c_api'>PyFloat_FromDouble</span>(((__pyx_v_Y_shape * __pyx_v_pixel_size) / 2.));<span class='error_goto'> if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 117, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_9);
</pre><pre class="cython line score-15" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">118</span>:                                             <span class="n">pixel_size</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">DTYPE</span><span class="p">)</span></pre>
<pre class='cython code score-15 '>  __pyx_t_2 = <span class='py_c_api'>PyFloat_FromDouble</span>(__pyx_v_pixel_size);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 118, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
/* … */
  __pyx_t_2 = <span class='pyx_c_api'>__Pyx_PyDict_NewPresized</span>(1);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 118, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
  <span class='pyx_c_api'>__Pyx_GetModuleGlobalName</span>(__pyx_t_9, __pyx_n_s_DTYPE);<span class='error_goto'> if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 118, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_9);
  if (<span class='py_c_api'>PyDict_SetItem</span>(__pyx_t_2, __pyx_n_s_dtype, __pyx_t_9) &lt; 0) <span class='error_goto'>__PYX_ERR(0, 118, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_9); __pyx_t_9 = 0;
</pre><pre class="cython line score-0">&#xA0;<span class="">119</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">120</span>:     <span class="c"># Variables for the different steps of the computation.</span></pre>
<pre class="cython line score-32" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">121</span>:     <span class="k">cdef</span> <span class="kt">DTYPE_t</span> [<span class="p">:]</span> <span class="n">F_j</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">Y_shape</span> <span class="o">*</span> <span class="n">X_shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">DTYPE</span><span class="p">)</span></pre>
<pre class='cython code score-32 '>  <span class='pyx_c_api'>__Pyx_GetModuleGlobalName</span>(__pyx_t_9, __pyx_n_s_numpy);<span class='error_goto'> if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 121, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_9);
  __pyx_t_2 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_t_9, __pyx_n_s_empty);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 121, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_9); __pyx_t_9 = 0;
  __pyx_t_9 = <span class='py_c_api'>PyInt_FromSsize_t</span>((__pyx_v_Y_shape * __pyx_v_X_shape));<span class='error_goto'> if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 121, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_9);
  __pyx_t_1 = <span class='py_c_api'>PyTuple_New</span>(1);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 121, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
  <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_t_9);
  <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_1, 0, __pyx_t_9);
  __pyx_t_9 = 0;
  __pyx_t_9 = <span class='pyx_c_api'>__Pyx_PyDict_NewPresized</span>(1);<span class='error_goto'> if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 121, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_9);
  <span class='pyx_c_api'>__Pyx_GetModuleGlobalName</span>(__pyx_t_8, __pyx_n_s_DTYPE);<span class='error_goto'> if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 121, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_8);
  if (<span class='py_c_api'>PyDict_SetItem</span>(__pyx_t_9, __pyx_n_s_dtype, __pyx_t_8) &lt; 0) <span class='error_goto'>__PYX_ERR(0, 121, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_8); __pyx_t_8 = 0;
  __pyx_t_8 = <span class='pyx_c_api'>__Pyx_PyObject_Call</span>(__pyx_t_2, __pyx_t_1, __pyx_t_9);<span class='error_goto'> if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 121, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_8);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_9); __pyx_t_9 = 0;
  __pyx_t_10 = __Pyx_PyObject_to_MemoryviewSlice_ds_nn___pyx_t_5seiya_4cube_6cubify_DTYPE_t(__pyx_t_8, PyBUF_WRITABLE);<span class='error_goto'> if (unlikely(!__pyx_t_10.memview)) __PYX_ERR(0, 121, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_8); __pyx_t_8 = 0;
  __pyx_v_F_j = __pyx_t_10;
  __pyx_t_10.memview = NULL;
  __pyx_t_10.data = NULL;
</pre><pre class="cython line score-0">&#xA0;<span class="">122</span>:     <span class="k">cdef</span> <span class="kt">DTYPE_t</span> [<span class="p">:,</span> <span class="p">:]</span> <span class="n">w_ij</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">123</span>:     <span class="k">cdef</span> <span class="kt">DTYPE_t</span> <span class="nf">r2_ij</span><span class="p">,</span> <span class="nf">w_sum</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">124</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">125</span>:     <span class="c"># The final datacube.</span></pre>
<pre class="cython line score-50" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">126</span>:     <span class="k">cdef</span> <span class="kt">DTYPE_t</span> [<span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="n">F_ijw</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">nwave</span><span class="p">,</span> <span class="n">Y_shape</span><span class="p">,</span> <span class="n">X_shape</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">DTYPE</span><span class="p">)</span></pre>
<pre class='cython code score-50 '>  <span class='pyx_c_api'>__Pyx_GetModuleGlobalName</span>(__pyx_t_8, __pyx_n_s_numpy);<span class='error_goto'> if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 126, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_8);
  __pyx_t_9 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_t_8, __pyx_n_s_empty);<span class='error_goto'> if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 126, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_9);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_8); __pyx_t_8 = 0;
  __pyx_t_8 = <span class='py_c_api'>PyInt_FromSsize_t</span>(__pyx_v_nwave);<span class='error_goto'> if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 126, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_8);
  __pyx_t_1 = <span class='py_c_api'>PyInt_FromSsize_t</span>(__pyx_v_Y_shape);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 126, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
  __pyx_t_2 = <span class='py_c_api'>PyInt_FromSsize_t</span>(__pyx_v_X_shape);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 126, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
  __pyx_t_4 = <span class='py_c_api'>PyTuple_New</span>(3);<span class='error_goto'> if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 126, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_4);
  <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_t_8);
  <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_4, 0, __pyx_t_8);
  <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_t_1);
  <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_4, 1, __pyx_t_1);
  <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_t_2);
  <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_4, 2, __pyx_t_2);
  __pyx_t_8 = 0;
  __pyx_t_1 = 0;
  __pyx_t_2 = 0;
  __pyx_t_2 = <span class='py_c_api'>PyTuple_New</span>(1);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 126, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
  <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_t_4);
  <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_2, 0, __pyx_t_4);
  __pyx_t_4 = 0;
  __pyx_t_4 = <span class='pyx_c_api'>__Pyx_PyDict_NewPresized</span>(1);<span class='error_goto'> if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 126, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_4);
  <span class='pyx_c_api'>__Pyx_GetModuleGlobalName</span>(__pyx_t_1, __pyx_n_s_DTYPE);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 126, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
  if (<span class='py_c_api'>PyDict_SetItem</span>(__pyx_t_4, __pyx_n_s_dtype, __pyx_t_1) &lt; 0) <span class='error_goto'>__PYX_ERR(0, 126, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
  __pyx_t_1 = <span class='pyx_c_api'>__Pyx_PyObject_Call</span>(__pyx_t_9, __pyx_t_2, __pyx_t_4);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 126, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_9); __pyx_t_9 = 0;
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_4); __pyx_t_4 = 0;
  __pyx_t_11 = __Pyx_PyObject_to_MemoryviewSlice_dsdsds_nn___pyx_t_5seiya_4cube_6cubify_DTYPE_t(__pyx_t_1, PyBUF_WRITABLE);<span class='error_goto'> if (unlikely(!__pyx_t_11.memview)) __PYX_ERR(0, 126, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
  __pyx_v_F_ijw = __pyx_t_11;
  __pyx_t_11.memview = NULL;
  __pyx_t_11.data = NULL;
</pre><pre class="cython line score-0">&#xA0;<span class="">127</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">128</span>:     <span class="c"># Loop over each one of the wavelength planes.</span></pre>
<pre class="cython line score-0" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">129</span>:     <span class="k">for</span> <span class="n">iwave</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nwave</span><span class="p">):</span></pre>
<pre class='cython code score-0 '>  __pyx_t_7 = __pyx_v_nwave;
  __pyx_t_6 = __pyx_t_7;
  for (__pyx_t_12 = 0; __pyx_t_12 &lt; __pyx_t_6; __pyx_t_12+=1) {
    __pyx_v_iwave = __pyx_t_12;
</pre><pre class="cython line score-0">&#xA0;<span class="">130</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">131</span>:         <span class="c"># Set the weights for this wavelength to zero.</span></pre>
<pre class="cython line score-44" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">132</span>:         <span class="n">w_ij</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nfibres</span><span class="p">,</span> <span class="n">X_shape</span> <span class="o">*</span> <span class="n">Y_shape</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">DTYPE</span><span class="p">)</span></pre>
<pre class='cython code score-44 '>    <span class='pyx_c_api'>__Pyx_GetModuleGlobalName</span>(__pyx_t_1, __pyx_n_s_numpy);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 132, __pyx_L1_error)</span>
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
    __pyx_t_4 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_t_1, __pyx_n_s_zeros);<span class='error_goto'> if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 132, __pyx_L1_error)</span>
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_4);
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
    __pyx_t_1 = <span class='py_c_api'>PyInt_FromSsize_t</span>(__pyx_v_nfibres);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 132, __pyx_L1_error)</span>
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
    __pyx_t_2 = <span class='py_c_api'>PyInt_FromSsize_t</span>((__pyx_v_X_shape * __pyx_v_Y_shape));<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 132, __pyx_L1_error)</span>
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
    __pyx_t_9 = <span class='py_c_api'>PyTuple_New</span>(2);<span class='error_goto'> if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 132, __pyx_L1_error)</span>
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_9);
    <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_t_1);
    <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_9, 0, __pyx_t_1);
    <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_t_2);
    <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_9, 1, __pyx_t_2);
    __pyx_t_1 = 0;
    __pyx_t_2 = 0;
    __pyx_t_2 = <span class='py_c_api'>PyTuple_New</span>(1);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 132, __pyx_L1_error)</span>
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
    <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_t_9);
    <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_2, 0, __pyx_t_9);
    __pyx_t_9 = 0;
    __pyx_t_9 = <span class='pyx_c_api'>__Pyx_PyDict_NewPresized</span>(1);<span class='error_goto'> if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 132, __pyx_L1_error)</span>
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_9);
    <span class='pyx_c_api'>__Pyx_GetModuleGlobalName</span>(__pyx_t_1, __pyx_n_s_DTYPE);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 132, __pyx_L1_error)</span>
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
    if (<span class='py_c_api'>PyDict_SetItem</span>(__pyx_t_9, __pyx_n_s_dtype, __pyx_t_1) &lt; 0) <span class='error_goto'>__PYX_ERR(0, 132, __pyx_L1_error)</span>
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
    __pyx_t_1 = <span class='pyx_c_api'>__Pyx_PyObject_Call</span>(__pyx_t_4, __pyx_t_2, __pyx_t_9);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 132, __pyx_L1_error)</span>
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_4); __pyx_t_4 = 0;
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_9); __pyx_t_9 = 0;
    __pyx_t_13 = __Pyx_PyObject_to_MemoryviewSlice_dsds_nn___pyx_t_5seiya_4cube_6cubify_DTYPE_t(__pyx_t_1, PyBUF_WRITABLE);<span class='error_goto'> if (unlikely(!__pyx_t_13.memview)) __PYX_ERR(0, 132, __pyx_L1_error)</span>
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
    __PYX_XDEC_MEMVIEW(&amp;__pyx_v_w_ij, 1);
    __pyx_v_w_ij = __pyx_t_13;
    __pyx_t_13.memview = NULL;
    __pyx_t_13.data = NULL;
</pre><pre class="cython line score-0">&#xA0;<span class="">133</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">134</span>:         <span class="c"># Calculate the contribution of each fibre to the weights.</span></pre>
<pre class="cython line score-0" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">135</span>:         <span class="k">for</span> <span class="n">ifibre</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nfibres</span><span class="p">):</span></pre>
<pre class='cython code score-0 '>    __pyx_t_14 = __pyx_v_nfibres;
    __pyx_t_15 = __pyx_t_14;
    for (__pyx_t_16 = 0; __pyx_t_16 &lt; __pyx_t_15; __pyx_t_16+=1) {
      __pyx_v_ifibre = __pyx_t_16;
</pre><pre class="cython line score-0">&#xA0;<span class="">136</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">137</span>:             <span class="c"># If the ivar for this fibre and wavelength is zero, this fibre</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">138</span>:             <span class="c"># does not contribute, so skip.</span></pre>
<pre class="cython line score-0" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">139</span>:             <span class="k">if</span> <span class="n">ivar</span><span class="p">[</span><span class="n">ifibre</span><span class="p">,</span> <span class="n">iwave</span><span class="p">]</span> <span class="o">==</span> <span class="mf">0</span><span class="p">:</span></pre>
<pre class='cython code score-0 '>      __pyx_t_17 = __pyx_v_ifibre;
      __pyx_t_18 = __pyx_v_iwave;
      __pyx_t_19 = (((*((__pyx_t_5seiya_4cube_6cubify_DTYPE_t *) ( /* dim=1 */ (( /* dim=0 */ (__pyx_v_ivar.data + __pyx_t_17 * __pyx_v_ivar.strides[0]) ) + __pyx_t_18 * __pyx_v_ivar.strides[1]) ))) == 0.0) != 0);
      if (__pyx_t_19) {
/* … */
      }
</pre><pre class="cython line score-0" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">140</span>:                 <span class="k">continue</span></pre>
<pre class='cython code score-0 '>        goto __pyx_L7_continue;
</pre><pre class="cython line score-0">&#xA0;<span class="">141</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">142</span>:             <span class="c"># Measured positions of this fibre for this wavelength.</span></pre>
<pre class="cython line score-0" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">143</span>:             <span class="n">fibre_xpos</span> <span class="o">=</span> <span class="n">xpos</span><span class="p">[</span><span class="n">ifibre</span><span class="p">,</span> <span class="n">iwave</span><span class="p">]</span></pre>
<pre class='cython code score-0 '>      __pyx_t_20 = __pyx_v_ifibre;
      __pyx_t_21 = __pyx_v_iwave;
      __pyx_v_fibre_xpos = (*((__pyx_t_5seiya_4cube_6cubify_DTYPE_t *) ( /* dim=1 */ (( /* dim=0 */ (__pyx_v_xpos.data + __pyx_t_20 * __pyx_v_xpos.strides[0]) ) + __pyx_t_21 * __pyx_v_xpos.strides[1]) )));
</pre><pre class="cython line score-0" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">144</span>:             <span class="n">fibre_ypos</span> <span class="o">=</span> <span class="n">ypos</span><span class="p">[</span><span class="n">ifibre</span><span class="p">,</span> <span class="n">iwave</span><span class="p">]</span></pre>
<pre class='cython code score-0 '>      __pyx_t_22 = __pyx_v_ifibre;
      __pyx_t_23 = __pyx_v_iwave;
      __pyx_v_fibre_ypos = (*((__pyx_t_5seiya_4cube_6cubify_DTYPE_t *) ( /* dim=1 */ (( /* dim=0 */ (__pyx_v_ypos.data + __pyx_t_22 * __pyx_v_ypos.strides[0]) ) + __pyx_t_23 * __pyx_v_ypos.strides[1]) )));
</pre><pre class="cython line score-0">&#xA0;<span class="">145</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">146</span>:             <span class="c"># Loop over each one of the elements in the grid.</span></pre>
<pre class="cython line score-0" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">147</span>:             <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">X_shape</span><span class="p">):</span></pre>
<pre class='cython code score-0 '>      __pyx_t_24 = __pyx_v_X_shape;
      __pyx_t_25 = __pyx_t_24;
      for (__pyx_t_26 = 0; __pyx_t_26 &lt; __pyx_t_25; __pyx_t_26+=1) {
        __pyx_v_ii = __pyx_t_26;
</pre><pre class="cython line score-0">&#xA0;<span class="">148</span>: </pre>
<pre class="cython line score-0" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">149</span>:                 <span class="n">X_test</span> <span class="o">=</span> <span class="n">X_range</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>  <span class="c"># X value in the grid.</span></pre>
<pre class='cython code score-0 '>        __pyx_t_27 = __pyx_v_ii;
        __pyx_v_X_test = (*((__pyx_t_5seiya_4cube_6cubify_DTYPE_t *) ( /* dim=0 */ (__pyx_v_X_range.data + __pyx_t_27 * __pyx_v_X_range.strides[0]) )));
</pre><pre class="cython line score-0">&#xA0;<span class="">150</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">151</span>:                 <span class="c"># If the distance from X_test and fibre_xpos is larger than</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">152</span>:                 <span class="c"># rlimit plus some padding, skip this grid point since the</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">153</span>:                 <span class="c"># fibre does not contribute. We&#39;ll do the same with Y_test.</span></pre>
<pre class="cython line score-0" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">154</span>:                 <span class="k">if</span> <span class="p">(</span><span class="n">X_test</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">fibre_xpos</span> <span class="o">-</span> <span class="n">window_seach_size</span><span class="p">)</span> <span class="ow">or</span></pre>
<pre class='cython code score-0 '>        __pyx_t_28 = ((__pyx_v_X_test &lt; (__pyx_v_fibre_xpos - __pyx_v_window_seach_size)) != 0);
        if (!__pyx_t_28) {
        } else {
          __pyx_t_19 = __pyx_t_28;
          goto __pyx_L13_bool_binop_done;
        }
/* … */
        if (__pyx_t_19) {
/* … */
        }
</pre><pre class="cython line score-0" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">155</span>:                         <span class="n">X_test</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">fibre_xpos</span> <span class="o">+</span> <span class="n">window_seach_size</span><span class="p">)):</span></pre>
<pre class='cython code score-0 '>        __pyx_t_28 = ((__pyx_v_X_test &gt; (__pyx_v_fibre_xpos + __pyx_v_window_seach_size)) != 0);
        __pyx_t_19 = __pyx_t_28;
        __pyx_L13_bool_binop_done:;
</pre><pre class="cython line score-0" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">156</span>:                     <span class="k">continue</span></pre>
<pre class='cython code score-0 '>          goto __pyx_L10_continue;
</pre><pre class="cython line score-0">&#xA0;<span class="">157</span>: </pre>
<pre class="cython line score-0" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">158</span>:                 <span class="k">for</span> <span class="n">jj</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">Y_shape</span><span class="p">):</span></pre>
<pre class='cython code score-0 '>        __pyx_t_29 = __pyx_v_Y_shape;
        __pyx_t_30 = __pyx_t_29;
        for (__pyx_t_31 = 0; __pyx_t_31 &lt; __pyx_t_30; __pyx_t_31+=1) {
          __pyx_v_jj = __pyx_t_31;
</pre><pre class="cython line score-0">&#xA0;<span class="">159</span>: </pre>
<pre class="cython line score-0" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">160</span>:                     <span class="n">Y_test</span> <span class="o">=</span> <span class="n">Y_range</span><span class="p">[</span><span class="n">jj</span><span class="p">]</span></pre>
<pre class='cython code score-0 '>          __pyx_t_32 = __pyx_v_jj;
          __pyx_v_Y_test = (*((__pyx_t_5seiya_4cube_6cubify_DTYPE_t *) ( /* dim=0 */ (__pyx_v_Y_range.data + __pyx_t_32 * __pyx_v_Y_range.strides[0]) )));
</pre><pre class="cython line score-0">&#xA0;<span class="">161</span>: </pre>
<pre class="cython line score-0" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">162</span>:                     <span class="k">if</span> <span class="p">(</span><span class="n">Y_test</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">fibre_ypos</span> <span class="o">-</span> <span class="n">window_seach_size</span><span class="p">)</span> <span class="ow">or</span></pre>
<pre class='cython code score-0 '>          __pyx_t_28 = ((__pyx_v_Y_test &lt; (__pyx_v_fibre_ypos - __pyx_v_window_seach_size)) != 0);
          if (!__pyx_t_28) {
          } else {
            __pyx_t_19 = __pyx_t_28;
            goto __pyx_L18_bool_binop_done;
          }
/* … */
          if (__pyx_t_19) {
/* … */
          }
</pre><pre class="cython line score-0" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">163</span>:                             <span class="n">Y_test</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">fibre_ypos</span> <span class="o">+</span> <span class="n">window_seach_size</span><span class="p">)):</span></pre>
<pre class='cython code score-0 '>          __pyx_t_28 = ((__pyx_v_Y_test &gt; (__pyx_v_fibre_ypos + __pyx_v_window_seach_size)) != 0);
          __pyx_t_19 = __pyx_t_28;
          __pyx_L18_bool_binop_done:;
</pre><pre class="cython line score-0" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">164</span>:                         <span class="k">continue</span></pre>
<pre class='cython code score-0 '>            goto __pyx_L15_continue;
</pre><pre class="cython line score-0">&#xA0;<span class="">165</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">166</span>:                     <span class="c"># Calculate the square of the distance between the grid</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">167</span>:                     <span class="c"># point and the fibre position. If it&#39;s &gt; rlimit, skip.</span></pre>
<pre class="cython line score-0" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">168</span>:                     <span class="n">r2_ij</span> <span class="o">=</span> <span class="p">(</span><span class="n">X_test</span> <span class="o">-</span> <span class="n">fibre_xpos</span><span class="p">)</span><span class="o">**</span><span class="mf">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">Y_test</span> <span class="o">-</span> <span class="n">fibre_ypos</span><span class="p">)</span><span class="o">**</span><span class="mf">2</span></pre>
<pre class='cython code score-0 '>          __pyx_v_r2_ij = (powf((__pyx_v_X_test - __pyx_v_fibre_xpos), 2.0) + powf((__pyx_v_Y_test - __pyx_v_fibre_ypos), 2.0));
</pre><pre class="cython line score-0" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">169</span>:                     <span class="k">if</span> <span class="n">r2_ij</span> <span class="o">&gt;</span> <span class="n">rlimit2</span><span class="p">:</span></pre>
<pre class='cython code score-0 '>          __pyx_t_19 = ((__pyx_v_r2_ij &gt; __pyx_v_rlimit2) != 0);
          if (__pyx_t_19) {
/* … */
          }
</pre><pre class="cython line score-0" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">170</span>:                         <span class="k">continue</span></pre>
<pre class='cython code score-0 '>            goto __pyx_L15_continue;
</pre><pre class="cython line score-0">&#xA0;<span class="">171</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">172</span>:                     <span class="c"># Use a Gaussian kernel to determine the contribution of</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">173</span>:                     <span class="c"># the fibre to to this point on the grid.</span></pre>
<pre class="cython line score-0" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">174</span>:                     <span class="n">w_ij</span><span class="p">[</span><span class="n">ifibre</span><span class="p">,</span> <span class="n">ii</span> <span class="o">*</span> <span class="n">X_shape</span> <span class="o">+</span> <span class="n">jj</span><span class="p">]</span> <span class="o">+=</span> <span class="n">exp</span><span class="p">(</span><span class="n">exp_coeff</span> <span class="o">*</span> <span class="n">r2_ij</span><span class="p">)</span></pre>
<pre class='cython code score-0 '>          __pyx_t_33 = __pyx_v_ifibre;
          __pyx_t_34 = ((__pyx_v_ii * __pyx_v_X_shape) + __pyx_v_jj);
          *((__pyx_t_5seiya_4cube_6cubify_DTYPE_t *) ( /* dim=1 */ (( /* dim=0 */ (__pyx_v_w_ij.data + __pyx_t_33 * __pyx_v_w_ij.strides[0]) ) + __pyx_t_34 * __pyx_v_w_ij.strides[1]) )) += exp((__pyx_v_exp_coeff * __pyx_v_r2_ij));
          __pyx_L15_continue:;
        }
        __pyx_L10_continue:;
      }
      __pyx_L7_continue:;
    }
</pre><pre class="cython line score-0">&#xA0;<span class="">175</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">176</span>:         <span class="c"># Normalise the weights and calculate the flux for each</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">177</span>:         <span class="c"># point on the grid.</span></pre>
<pre class="cython line score-0" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">178</span>:         <span class="k">for</span> <span class="n">jj</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">X_shape</span> <span class="o">*</span> <span class="n">Y_shape</span><span class="p">):</span></pre>
<pre class='cython code score-0 '>    __pyx_t_14 = (__pyx_v_X_shape * __pyx_v_Y_shape);
    __pyx_t_15 = __pyx_t_14;
    for (__pyx_t_16 = 0; __pyx_t_16 &lt; __pyx_t_15; __pyx_t_16+=1) {
      __pyx_v_jj = __pyx_t_16;
</pre><pre class="cython line score-0">&#xA0;<span class="">179</span>: </pre>
<pre class="cython line score-0" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">180</span>:             <span class="n">w_sum</span> <span class="o">=</span> <span class="mf">0.0</span></pre>
<pre class='cython code score-0 '>      __pyx_v_w_sum = 0.0;
</pre><pre class="cython line score-0" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">181</span>:             <span class="n">F_j</span><span class="p">[</span><span class="n">jj</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span></pre>
<pre class='cython code score-0 '>      __pyx_t_35 = __pyx_v_jj;
      *((__pyx_t_5seiya_4cube_6cubify_DTYPE_t *) ( /* dim=0 */ (__pyx_v_F_j.data + __pyx_t_35 * __pyx_v_F_j.strides[0]) )) = 0.0;
</pre><pre class="cython line score-0">&#xA0;<span class="">182</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">183</span>:             <span class="c"># Calculate the sum of all the weights for this point on the grid.</span></pre>
<pre class="cython line score-0" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">184</span>:             <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">nfibres</span><span class="p">):</span></pre>
<pre class='cython code score-0 '>      __pyx_t_24 = __pyx_v_nfibres;
      __pyx_t_25 = __pyx_t_24;
      for (__pyx_t_26 = 0; __pyx_t_26 &lt; __pyx_t_25; __pyx_t_26+=1) {
        __pyx_v_ii = __pyx_t_26;
</pre><pre class="cython line score-0" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">185</span>:                 <span class="n">w_sum</span> <span class="o">+=</span> <span class="n">w_ij</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="n">jj</span><span class="p">]</span></pre>
<pre class='cython code score-0 '>        __pyx_t_36 = __pyx_v_ii;
        __pyx_t_37 = __pyx_v_jj;
        __pyx_v_w_sum = (__pyx_v_w_sum + (*((__pyx_t_5seiya_4cube_6cubify_DTYPE_t *) ( /* dim=1 */ (( /* dim=0 */ (__pyx_v_w_ij.data + __pyx_t_36 * __pyx_v_w_ij.strides[0]) ) + __pyx_t_37 * __pyx_v_w_ij.strides[1]) ))));
      }
</pre><pre class="cython line score-0">&#xA0;<span class="">186</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">187</span>:             <span class="c"># If the weights are zero, skip.</span></pre>
<pre class="cython line score-0" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">188</span>:             <span class="k">if</span> <span class="n">w_sum</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span></pre>
<pre class='cython code score-0 '>      __pyx_t_19 = ((__pyx_v_w_sum == 0.0) != 0);
      if (__pyx_t_19) {
/* … */
      }
</pre><pre class="cython line score-0" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">189</span>:                 <span class="k">continue</span></pre>
<pre class='cython code score-0 '>        goto __pyx_L21_continue;
</pre><pre class="cython line score-0">&#xA0;<span class="">190</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">191</span>:             <span class="c"># Calculate the product of the matrix between the weights and the</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">192</span>:             <span class="c"># flux for this point on the grid.</span></pre>
<pre class="cython line score-0" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">193</span>:             <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">nfibres</span><span class="p">):</span></pre>
<pre class='cython code score-0 '>      __pyx_t_24 = __pyx_v_nfibres;
      __pyx_t_25 = __pyx_t_24;
      for (__pyx_t_26 = 0; __pyx_t_26 &lt; __pyx_t_25; __pyx_t_26+=1) {
        __pyx_v_ii = __pyx_t_26;
</pre><pre class="cython line score-5" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">194</span>:                 <span class="n">F_j</span><span class="p">[</span><span class="n">jj</span><span class="p">]</span> <span class="o">+=</span> <span class="n">alpha</span> <span class="o">*</span> <span class="n">w_ij</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="n">jj</span><span class="p">]</span> <span class="o">/</span> <span class="n">w_sum</span> <span class="o">*</span> <span class="n">flux</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="n">iwave</span><span class="p">]</span></pre>
<pre class='cython code score-5 '>        __pyx_t_38 = __pyx_v_ii;
        __pyx_t_39 = __pyx_v_jj;
        __pyx_t_3 = (__pyx_v_alpha * (*((__pyx_t_5seiya_4cube_6cubify_DTYPE_t *) ( /* dim=1 */ (( /* dim=0 */ (__pyx_v_w_ij.data + __pyx_t_38 * __pyx_v_w_ij.strides[0]) ) + __pyx_t_39 * __pyx_v_w_ij.strides[1]) ))));
        if (unlikely(__pyx_v_w_sum == 0)) {
          <span class='py_c_api'>PyErr_SetString</span>(PyExc_ZeroDivisionError, "float division");
          <span class='error_goto'>__PYX_ERR(0, 194, __pyx_L1_error)</span>
        }
        __pyx_t_40 = __pyx_v_ii;
        __pyx_t_41 = __pyx_v_iwave;
        __pyx_t_42 = __pyx_v_jj;
        *((__pyx_t_5seiya_4cube_6cubify_DTYPE_t *) ( /* dim=0 */ (__pyx_v_F_j.data + __pyx_t_42 * __pyx_v_F_j.strides[0]) )) += ((__pyx_t_3 / __pyx_v_w_sum) * (*((__pyx_t_5seiya_4cube_6cubify_DTYPE_t *) ( /* dim=1 */ (( /* dim=0 */ (__pyx_v_flux.data + __pyx_t_40 * __pyx_v_flux.strides[0]) ) + __pyx_t_41 * __pyx_v_flux.strides[1]) ))));
      }
      __pyx_L21_continue:;
    }
</pre><pre class="cython line score-0">&#xA0;<span class="">195</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">196</span>:         <span class="c"># Reshape F_j to a square grid and store the value for this wavelength</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">197</span>:         <span class="c"># plane.</span></pre>
<pre class="cython line score-0" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">198</span>:         <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">X_shape</span><span class="p">):</span></pre>
<pre class='cython code score-0 '>    __pyx_t_14 = __pyx_v_X_shape;
    __pyx_t_15 = __pyx_t_14;
    for (__pyx_t_16 = 0; __pyx_t_16 &lt; __pyx_t_15; __pyx_t_16+=1) {
      __pyx_v_ii = __pyx_t_16;
</pre><pre class="cython line score-0" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">199</span>:             <span class="k">for</span> <span class="n">jj</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">Y_shape</span><span class="p">):</span></pre>
<pre class='cython code score-0 '>      __pyx_t_24 = __pyx_v_Y_shape;
      __pyx_t_25 = __pyx_t_24;
      for (__pyx_t_26 = 0; __pyx_t_26 &lt; __pyx_t_25; __pyx_t_26+=1) {
        __pyx_v_jj = __pyx_t_26;
</pre><pre class="cython line score-0" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">200</span>:                 <span class="n">F_ijw</span><span class="p">[</span><span class="n">iwave</span><span class="p">,</span> <span class="n">jj</span><span class="p">,</span> <span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">F_j</span><span class="p">[</span><span class="n">X_shape</span> <span class="o">*</span> <span class="n">ii</span> <span class="o">+</span> <span class="n">jj</span><span class="p">]</span></pre>
<pre class='cython code score-0 '>        __pyx_t_43 = ((__pyx_v_X_shape * __pyx_v_ii) + __pyx_v_jj);
        __pyx_t_44 = __pyx_v_iwave;
        __pyx_t_45 = __pyx_v_jj;
        __pyx_t_46 = __pyx_v_ii;
        *((__pyx_t_5seiya_4cube_6cubify_DTYPE_t *) ( /* dim=2 */ (( /* dim=1 */ (( /* dim=0 */ (__pyx_v_F_ijw.data + __pyx_t_44 * __pyx_v_F_ijw.strides[0]) ) + __pyx_t_45 * __pyx_v_F_ijw.strides[1]) ) + __pyx_t_46 * __pyx_v_F_ijw.strides[2]) )) = (*((__pyx_t_5seiya_4cube_6cubify_DTYPE_t *) ( /* dim=0 */ (__pyx_v_F_j.data + __pyx_t_43 * __pyx_v_F_j.strides[0]) )));
      }
    }
  }
</pre><pre class="cython line score-0">&#xA0;<span class="">201</span>: </pre>
<pre class="cython line score-1" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">202</span>:     <span class="k">return</span> <span class="n">F_ijw</span></pre>
<pre class='cython code score-1 '>  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_r);
  __pyx_t_1 = __pyx_memoryview_fromslice(__pyx_v_F_ijw, 3, (PyObject *(*)(char *)) __pyx_memview_get_nn___pyx_t_5seiya_4cube_6cubify_DTYPE_t, (int (*)(char *, PyObject *)) __pyx_memview_set_nn___pyx_t_5seiya_4cube_6cubify_DTYPE_t, 0);;<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 202, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
  __pyx_r = __pyx_t_1;
  __pyx_t_1 = 0;
  goto __pyx_L0;
</pre></div></body></html>
